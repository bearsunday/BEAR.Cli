#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace BEAR\Cli;

use BEAR\AppMeta\Meta;

require dirname(__DIR__, 4) . '/vendor/autoload.php';

if ($argc < 2) {
    echo 'Usage: bear-cli-gen <app-name>' . PHP_EOL;
    echo '  e.g. bear-cli-gen MyVendor\MyApp' . PHP_EOL;
    exit(1);
}

$appName = $argv[1];
try {
    // Generate CLI commands
    $meta = new Meta($appName);
    $compiler = new CompileScript(new GenScript());
    $sources = $compiler->compile($meta);

    echo sprintf('CLI commands have been generated in %s:', $meta->appDir . '/bin') . PHP_EOL;
    foreach ($sources as $source) {
        echo sprintf('  %s', $source->name) . PHP_EOL;
    }

    // Generate Homebrew formula
    if (! is_dir($meta->appDir . '/.git')) {
        exit(0);
    }
    $formula = (new GenFormula())($meta);

    // Ensure directory exists
    $formulaDir = dirname($formula['path']);
    if (! is_dir($formulaDir)) {
        mkdir($formulaDir, 0755, true);
    }

    // Save formula
    file_put_contents($formula['path'], $formula['content']);
    echo sprintf('Homebrew formula has been generated: %s', $formula['path']) . PHP_EOL;

} catch (\Exception $e) {
    echo 'Error: ' . $e->getMessage() . PHP_EOL;
    exit(1);
}
